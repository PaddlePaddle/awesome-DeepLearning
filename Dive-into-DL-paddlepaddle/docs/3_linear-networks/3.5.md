```python
!pip install -U d2l
!python -m pip install paddlepaddle -i https://mirror.baidu.com/pypi/simple
```

# 3.5 å›¾åƒåˆ†ç±»æ•°æ®é›†




```python
import torch
import torchvision
from torch.utils import data
from torchvision import transforms
from d2l import torch as d2l
import paddle
import matplotlib.pyplot as plt
import numpy as np
```

## 3.5.1 è¯»å–æ•°æ®é›†
å¯ä»¥é€šè¿‡æ¡†æ¶ä¸­çš„å†…ç½®å‡½æ•°å°†Fashion-MNISTæ•°æ®é›†ä¸‹è½½å¹¶è¯»å–åˆ°å†…å­˜ä¸­ã€‚

#### torchç‰ˆ


```python
# é€šè¿‡ToTensorå®ä¾‹å°†å›¾åƒæ•°æ®ä»PILç±»å‹å˜æ¢æˆ32ä½æµ®ç‚¹æ•°æ ¼å¼
# å¹¶é™¤ä»¥255ä½¿å¾—æ‰€æœ‰åƒç´ çš„æ•°å€¼å‡åœ¨0åˆ°1ä¹‹é—´
trans = transforms.ToTensor()
mnist_train = torchvision.datasets.FashionMNIST(
    root="../data", train=True, transform=trans, download=True)
mnist_test = torchvision.datasets.FashionMNIST(
    root="../data", train=False, transform=trans, download=True)
```

Fashion-MNISTç”±10ä¸ªç±»åˆ«çš„å›¾åƒç»„æˆï¼Œæ¯ä¸ªç±»åˆ«ç”±è®­ç»ƒæ•°æ®é›†ä¸­çš„6000å¼ å›¾åƒå’Œæµ‹è¯•æ•°æ®é›†ä¸­çš„1000å¼ å›¾åƒç»„æˆã€‚æµ‹è¯•æ•°æ®é›†ï¼ˆtest datasetï¼‰ä¸ä¼šç”¨äºè®­ç»ƒï¼Œåªç”¨äºè¯„ä¼°æ¨¡å‹æ€§èƒ½ã€‚è®­ç»ƒé›†å’Œæµ‹è¯•é›†åˆ†åˆ«åŒ…å«60000å’Œ10000å¼ å›¾åƒã€‚


```python
len(mnist_train),len(mnist_test)
```

æ¯ä¸ªè¾“å…¥å›¾åƒçš„é«˜åº¦å’Œå®½åº¦å‡ä¸º28åƒç´ ã€‚æ•°æ®é›†ç”±ç°åº¦å›¾åƒç»„æˆï¼Œå…¶é€šé“æ•°ä¸º1ã€‚ä¸ºäº†ç®€æ´èµ·è§ï¼Œåœ¨è¿™æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬å°†é«˜åº¦ â„ åƒç´ ï¼Œå®½åº¦ ğ‘¤ åƒç´ å›¾åƒçš„å½¢çŠ¶è®°ä¸º â„Ã—ğ‘¤æˆ–ï¼ˆ â„, ğ‘¤ï¼‰ã€‚


```python
mnist_train[0][0].shape
```

Fashion-MNISTä¸­åŒ…å«çš„10ä¸ªç±»åˆ«åˆ†åˆ«ä¸ºt-shirtï¼ˆTæ¤ï¼‰ã€trouserï¼ˆè£¤å­ï¼‰ã€pulloverï¼ˆå¥—è¡«ï¼‰ã€dressï¼ˆè¿è¡£è£™ï¼‰ã€coatï¼ˆå¤–å¥—ï¼‰ã€sandalï¼ˆå‡‰é‹ï¼‰ã€shirtï¼ˆè¡¬è¡«ï¼‰ã€sneakerï¼ˆè¿åŠ¨é‹ï¼‰ã€bagï¼ˆåŒ…ï¼‰å’Œankle bootï¼ˆçŸ­é´ï¼‰ã€‚ä»¥ä¸‹å‡½æ•°ç”¨äºåœ¨æ•°å­—æ ‡ç­¾ç´¢å¼•åŠå…¶æ–‡æœ¬åç§°ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚


```python
def get_fashion_mnist_labels(labels):
    """è¿”å›Fashion-MNISTæ•°æ®é›†çš„æ–‡æœ¬æ ‡ç­¾ã€‚"""
    text_labels = ['t-shirt', 'trouser', 'pullover', 'dress', 'coat','sandal', 'shirt', 'sneaker', 'bag', 'ankle boot']
    return [text_labels[int(i)] for i in labels]
```

å¯ä»¥åˆ›å»ºå‡½æ•°æ¥å¯è§†åŒ–è¿™äº›æ ·æœ¬


```python
def show_images(imgs, num_rows, num_cols, titles=None, scale=1.5):
    """Plot a list of images."""
    figsize = (num_cols * scale, num_rows * scale)
    _, axes = d2l.plt.subplots(num_rows, num_cols, figsize=figsize)
    axes = axes.flatten()
    for i, (ax, img) in enumerate(zip(axes, imgs)):
        if torch.is_tensor(img):
            # å›¾ç‰‡å¼ é‡
            ax.imshow(img.numpy())
        else:
            # PILå›¾ç‰‡
            ax.imshow(img)
        ax.axes.get_xaxis().set_visible(False)
        ax.axes.get_yaxis().set_visible(False)
        if titles:
            ax.set_title(titles[i])
    return axes
```

ä»¥ä¸‹æ˜¯è®­ç»ƒæ•°æ®é›†å‰å‡ ä¸ªæ ·æœ¬çš„å›¾åƒåŠå…¶å¯¹åº”æ ‡ç­¾ï¼ˆæ–‡æœ¬å½¢å¼ï¼‰


```python
X, y = next(iter(data.DataLoader(mnist_train, batch_size=18)))
print(X.shape)
show_images(X.reshape(18, 28, 28), 2, 9, titles=get_fashion_mnist_labels(y));
```

#### paddleç‰ˆ


```python

import paddle.vision.transforms as T
paddle_transform = T.Compose([T.Normalize(mean=[127.5],std=[127.5],data_format='CHW')])
paddle_train = paddle.vision.datasets.FashionMNIST(mode='train', transform=paddle_transform)
paddle_test = paddle.vision.datasets.FashionMNIST(mode='test', transform=paddle_transform)
print(len(paddle_train))
print(len(paddle_test))
print(paddle_train[0][0].shape)
```


```python
def paddle_show_images(imgs, num_rows, num_cols, titles=None, scale=1.5):
    """Plot a list of images."""
    figsize = (num_cols * scale, num_rows * scale)
    _, axes = plt.subplots(num_rows, num_cols, figsize=figsize)
    axes = axes.flatten()
    for i, (ax, img) in enumerate(zip(axes, imgs)):
        if paddle.is_tensor(img):
            # å›¾ç‰‡å¼ é‡
            ax.imshow(img.numpy())
        else:
            # PILå›¾ç‰‡
            ax.imshow(img)
        ax.axes.get_xaxis().set_visible(False)
        ax.axes.get_yaxis().set_visible(False)
        if titles:
            ax.set_title(titles[i])
    return axes
```


```python
from paddle.io import DataLoader
paddle_X, paddle_y = next(iter(DataLoader(paddle_train,batch_size=18)))
paddle_show_images(paddle_X.reshape((18, 28, 28)), 2, 9, titles=get_fashion_mnist_labels(paddle_y));
```

## 3.5 2 è¯»å–å°æ‰¹é‡
ä¸ºäº†ä½¿æˆ‘ä»¬åœ¨è¯»å–è®­ç»ƒé›†å’Œæµ‹è¯•é›†æ—¶æ›´å®¹æ˜“ï¼Œæˆ‘ä»¬ä½¿ç”¨å†…ç½®çš„æ•°æ®è¿­ä»£å™¨ï¼Œè€Œä¸æ˜¯ä»é›¶å¼€å§‹åˆ›å»ºä¸€ä¸ªã€‚ å›é¡¾ä¸€ä¸‹ï¼Œåœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œæ•°æ®åŠ è½½å™¨æ¯æ¬¡éƒ½ä¼šè¯»å–ä¸€å°æ‰¹é‡æ•°æ®ï¼Œå¤§å°ä¸ºbatch_sizeã€‚æˆ‘ä»¬åœ¨è®­ç»ƒæ•°æ®è¿­ä»£å™¨ä¸­è¿˜éšæœºæ‰“ä¹±äº†æ‰€æœ‰æ ·æœ¬ã€‚

#### torchç‰ˆ


```python
batch_size = 256

def get_dataloader_workers():
    """ä½¿ç”¨4ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®ã€‚"""
    return 4

train_iter = data.DataLoader(mnist_train, batch_size, shuffle=True,num_workers=get_dataloader_workers())
```

çœ‹ä¸€ä¸‹è¯»å–è®­ç»ƒæ•°æ®æ‰€éœ€æ—¶é—´ï¼š


```python
timer = d2l.Timer()
for X,y in train_iter:
  continue
f'{timer.stop():.2f} sec'
```

#### paddleç‰ˆ


```python
import time
class Timer:
  """Record multiple running times."""

  def __init__(self):
    self.times = []
    self.start()

  def start(self):
    """Start the timer."""
    self.tik = time.time()

  def stop(self):
    """Stop the timer and record the time in a list."""
    self.times.append(time.time() - self.tik)
    return self.times[-1]

  def avg(self):
    """Return the average time."""
    return sum(self.times) / len(self.times)

  def sum(self):
    """Return the sum of time."""
    return sum(self.times)

  def cumsum(self):
    """Return the accumulated time."""
    return np.array(self.times).cumsum().tolist()
```


```python
batch_size = 256

def paddle_get_dataloader_workers():
    """ä½¿ç”¨4ä¸ªè¿›ç¨‹æ¥è¯»å–æ•°æ®ã€‚"""
    return 4

paddle_train_iter = paddle.io.DataLoader(paddle_train, batch_size, shuffle=True,num_workers=paddle_get_dataloader_workers())
paddle_train_iter
```


```python
paddle_timer = Timer()
for iter_id, data in enumerate(paddle_train_iter()):
  X,y = data
  continue
f'{timer.stop():.2f} sec'
```

## 3.5.3 æ•´åˆæ‰€æœ‰ç»„ä»¶

3.5.3. æ•´åˆæ‰€æœ‰ç»„ä»¶
ç°åœ¨æˆ‘ä»¬å®šä¹‰load_data_fashion_mnistå‡½æ•°ï¼Œç”¨äºè·å–å’Œè¯»å–Fashion-MNISTæ•°æ®é›†ã€‚å®ƒè¿”å›è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ•°æ®è¿­ä»£å™¨ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æ¥å—ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œç”¨æ¥å°†å›¾åƒå¤§å°è°ƒæ•´ä¸ºå¦ä¸€ç§å½¢çŠ¶ã€‚

### torchç‰ˆ


```python
def load_data_fashion_mnist(batch_size, resize=None):
    """ä¸‹è½½Fashion-MNISTæ•°æ®é›†ï¼Œç„¶åå°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚"""
    trans = [T.Compose([T.Normalize(mean=[127.5],std=[127.5],data_format='CHW')])]
    if resize:
        trans.insert(0, transforms.Resize(resize))
    trans = transforms.Compose(trans)
    mnist_train = torchvision.datasets.FashionMNIST(
        root="../data", train=True, transform=trans, download=True)
    mnist_test = torchvision.datasets.FashionMNIST(
        root="../data", train=False, transform=trans, download=True)
    return (data.DataLoader(mnist_train, batch_size, shuffle=True,
                            num_workers=get_dataloader_workers()),
            data.DataLoader(mnist_test, batch_size, shuffle=False,
                            num_workers=get_dataloader_workers()))
```

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡æŒ‡å®šresizeå‚æ•°æ¥æµ‹è¯•load_data_fashion_mnistå‡½æ•°çš„å›¾åƒå¤§å°è°ƒæ•´åŠŸèƒ½ã€‚


```python
train_iter, test_iter = load_data_fashion_mnist(32, resize=64)
for X, y in train_iter:
    print(X.shape, X.dtype, y.shape, y.dtype)
    break
```

æˆ‘ä»¬ç°åœ¨å·²ç»å‡†å¤‡å¥½åœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ä½¿ç”¨Fashion-MNISTæ•°æ®é›†ã€‚

### paddleç‰ˆ


```python
def paddle_load_data_fashion_mnist(batch_size, resize=None):
    """ä¸‹è½½Fashion-MNISTæ•°æ®é›†ï¼Œç„¶åå°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚"""
    trans = [transforms.ToTensor()]
    if resize:
        trans.insert(0, transforms.Resize(resize))
    trans = transforms.Compose(trans)
    paddle_transform = T.Compose([T.Normalize(mean=[127.5],std=[127.5],data_format='CHW')])
    paddle_train = paddle.vision.datasets.FashionMNIST(mode='train', transform=paddle_transform)
    paddle_test = paddle.vision.datasets.FashionMNIST(mode='test', transform=paddle_transform)
    return (paddle.io.DataLoader(paddle_train, batch_size, shuffle=True,
                            num_workers=paddle_get_dataloader_workers()),
            paddle.io.DataLoader(paddle_test, batch_size, shuffle=False,
                            num_workers=paddle_get_dataloader_workers()))
```


```python

```
