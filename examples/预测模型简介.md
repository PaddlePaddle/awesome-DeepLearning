
CTR-DNN模型的组网比较直观，本质是一个二分类任务，代码参考`model.py`。模型主要组成是一个`Embedding`层，四个`FC`层，以及相应的分类任务的loss计算和auc计算。

### 数据输入
CTR-DNN模型的数据输入层包括三个，分别是：`dense_input`用于输入连续数据，维度由超参数`dense_input_dim`指定，数据类型是归一化后的浮点型数据。`sparse_inputs`用于记录离散数据，在Criteo数据集中，共有26个slot，所以我们创建了名为`1~26`的26个稀疏参数输入，数据类型为整数；最后是每条样本的`label`，代表了是否被点击，数据类型是整数，0代表负样例，1代表正样例。

#### Embedding层
首先介绍Embedding层的搭建方式：`Embedding`层的输入是`sparse_input`，由超参的`sparse_feature_number`和`sparse_feature_dimshape`定义。需要特别解释的是`is_sparse`参数，当我们指定`is_sprase=True`后，计算图会将该参数视为稀疏参数，反向更新以及分布式通信时，都以稀疏的方式进行，会极大的提升运行效率，同时保证效果一致。

各个稀疏的输入通过Embedding层后，将其合并起来，置于一个list内，以方便进行concat的操作。

#### FC层
将离散数据通过embedding查表得到的值，与连续数据的输入进行`concat`操作，合为一个整体输入，作为全链接层的原始输入。我们共设计了4层FC，每层FC的输出维度由超参`fc_sizes`指定，每层FC都后接一个`relu`激活函数，每层FC的初始化方式为符合正态分布的随机初始化，标准差与上一层的输出维度的平方根成反比。

#### Loss及Auc计算
- 预测的结果通过一个输出shape为2的FC层给出，该FC层的激活函数是softmax，会给出每条样本分属于正负样本的概率。
- 每条样本的损失由交叉熵给出，交叉熵的输入维度为[batch_size,2]，数据类型为float，label的输入维度为[batch_size,1]，数据类型为int。
- 该batch的损失`avg_cost`是各条样本的损失之和
- 我们同时还会计算预测的auc，auc的结果由`fluid.layers.auc()`给出，该层的返回值有三个，分别是从第一个batch累计到当前batch的全局auc: `auc`，最近几个batch的auc: `batch_auc`，以及auc_states: `_`，auc_states包含了`batch_stat_pos, batch_stat_neg, stat_pos, stat_neg`信息。`batch_auc`我们取近20个batch的平均，由参数`slide_steps=20`指定，roc曲线的离散化的临界数值设置为4096，由`num_thresholds=2**12`指定。

完成上述组网后，我们最终可以通过训练拿到`BATCH_AUC`与`auc`两个重要指标。



    
    ====================================================================================================
                    Runtime Envs                      Value                                             
    ----------------------------------------------------------------------------------------------------
    train.trainer.trainer                             GeneralTrainer                                    
    train.trainer.executor_mode                       train                                             
    train.trainer.threads                             2                                                 
    train.trainer.platform                            LINUX                                             
    train.trainer.engine                              single                                            
    ====================================================================================================
    
    QueueDataset can not support PY3, change to DataLoader
    
    ====================================================================================================
                paddlerec Global Envs                 Value                                             
    ----------------------------------------------------------------------------------------------------
    debug                                             False                                             
    workspace                                         .                                                 
    dataset.train_sample.name                         train_sample                                      
    dataset.train_sample.type                         DataLoader                                        
    dataset.train_sample.batch_size                   5                                                 
    dataset.train_sample.data_path                    ./data/                                           
    dataset.train_sample.sparse_slots                 ... 1 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26
    dataset.train_sample.dense_slots                  dense_feature:13                                  
    dataset.infer_sample.name                         infer_sample                                      
    dataset.infer_sample.type                         DataLoader                                        
    dataset.infer_sample.batch_size                   5                                                 
    dataset.infer_sample.data_path                    ./data/                                           
    dataset.infer_sample.sparse_slots                 ... 1 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26
    dataset.infer_sample.dense_slots                  dense_feature:13                                  
    hyper_parameters.optimizer.class                  Adam                                              
    hyper_parameters.optimizer.learning_rate          0.001                                             
    hyper_parameters.optimizer.strategy               async                                             
    hyper_parameters.sparse_inputs_slots              27                                                
    hyper_parameters.sparse_feature_number            1000001                                           
    hyper_parameters.sparse_feature_dim               9                                                 
    hyper_parameters.dense_input_dim                  13                                                
    hyper_parameters.fc_sizes                         [512, 256, 128, 32]                               
    hyper_parameters.distributed_embedding            0                                                 
    mode                                              ['train_runner', 'infer_runner']                  
    runner.train_runner.name                          train_runner                                      
    runner.train_runner.class                         train                                             
    runner.train_runner.epochs                        1                                                 
    runner.train_runner.device                        cpu                                               
    runner.train_runner.init_model_path                                                                 
    runner.train_runner.save_checkpoint_interval      1                                                 
    runner.train_runner.save_inference_interval       1                                                 
    runner.train_runner.save_checkpoint_path          increment                                         
    runner.train_runner.save_inference_path           inference                                         
    runner.train_runner.print_interval                1                                                 
    runner.train_runner.phases                        phase1                                            
    runner.infer_runner.name                          infer_runner                                      
    runner.infer_runner.class                         infer                                             
    runner.infer_runner.device                        cpu                                               
    runner.infer_runner.init_model_path               increment/0                                       
    runner.infer_runner.print_interval                1                                                 
    runner.infer_runner.phases                        infer_phase                                       
    phase.phase1.name                                 phase1                                            
    phase.phase1.model                                ./model.py                                        
    phase.phase1.dataset_name                         train_sample                                      
    phase.phase1.thread_num                           1                                                 
    phase.infer_phase.name                            infer_phase                                       
    phase.infer_phase.model                           ./model.py                                        
    phase.infer_phase.dataset_name                    infer_sample                                      
    phase.infer_phase.thread_num                      1                                                 
    ====================================================================================================
    
    PaddleRec: Runner train_runner Begin
    Executor Mode: train
    processor_register begin
    Running SingleInstance.
    Running SingleNetwork.
    Warning:please make sure there are no hidden files in the dataset folder and check these hidden files:[]
    QueueDataset can not support PY3, change to DataLoader
    QueueDataset can not support PY3, change to DataLoader
    Running SingleStartup.
    Running SingleRunner.
    !!! The CPU_NUM is not specified, you should set CPU_NUM in the environment variable list.
    CPU_NUM indicates that how many CPUPlace are used in the current task.
    And if this parameter are set as N (equal to the number of physical CPU core) the program may be faster.
    
    export CPU_NUM=24 # for example, set CPU_NUM as number of physical CPU core which is 24.
    
    !!! The default number of CPU_NUM=1.
    W0724 18:09:08.301381   990 build_strategy.cc:170] fusion_group is not enabled for Windows/MacOS now, and only effective when running with CUDA GPU.
    2021-07-24 18:09:08,346 - INFO: 	[Train],  epoch: 0,  batch: 1, time_each_interval: 0.05s, AUC: [0.3125], BATCH_AUC: [0.3125]
    2021-07-24 18:09:08,351 - INFO: 	[Train],  epoch: 0,  batch: 2, time_each_interval: 0.00s, AUC: [0.44444444], BATCH_AUC: [0.44444444]
    2021-07-24 18:09:08,355 - INFO: 	[Train],  epoch: 0,  batch: 3, time_each_interval: 0.00s, AUC: [0.515625], BATCH_AUC: [0.515625]
    2021-07-24 18:09:08,359 - INFO: 	[Train],  epoch: 0,  batch: 4, time_each_interval: 0.00s, AUC: [0.52], BATCH_AUC: [0.52]
    2021-07-24 18:09:08,364 - INFO: 	[Train],  epoch: 0,  batch: 5, time_each_interval: 0.00s, AUC: [0.616], BATCH_AUC: [0.616]
    2021-07-24 18:09:08,368 - INFO: 	[Train],  epoch: 0,  batch: 6, time_each_interval: 0.00s, AUC: [0.56321839], BATCH_AUC: [0.56321839]
    2021-07-24 18:09:08,372 - INFO: 	[Train],  epoch: 0,  batch: 7, time_each_interval: 0.00s, AUC: [0.53246753], BATCH_AUC: [0.53246753]
    2021-07-24 18:09:08,376 - INFO: 	[Train],  epoch: 0,  batch: 8, time_each_interval: 0.00s, AUC: [0.51013514], BATCH_AUC: [0.51013514]
    2021-07-24 18:09:08,380 - INFO: 	[Train],  epoch: 0,  batch: 9, time_each_interval: 0.00s, AUC: [0.475], BATCH_AUC: [0.475]
    2021-07-24 18:09:08,384 - INFO: 	[Train],  epoch: 0,  batch: 10, time_each_interval: 0.00s, AUC: [0.45930233], BATCH_AUC: [0.45930233]
    2021-07-24 18:09:08,388 - INFO: 	[Train],  epoch: 0,  batch: 11, time_each_interval: 0.00s, AUC: [0.45481481], BATCH_AUC: [0.45481481]
    2021-07-24 18:09:08,392 - INFO: 	[Train],  epoch: 0,  batch: 12, time_each_interval: 0.00s, AUC: [0.46446078], BATCH_AUC: [0.46446078]
    2021-07-24 18:09:08,396 - INFO: 	[Train],  epoch: 0,  batch: 13, time_each_interval: 0.00s, AUC: [0.49173955], BATCH_AUC: [0.49173955]
    2021-07-24 18:09:08,400 - INFO: 	[Train],  epoch: 0,  batch: 14, time_each_interval: 0.00s, AUC: [0.49498328], BATCH_AUC: [0.49498328]
    2021-07-24 18:09:08,404 - INFO: 	[Train],  epoch: 0,  batch: 15, time_each_interval: 0.00s, AUC: [0.4641495], BATCH_AUC: [0.4641495]
    epoch 0 done, use time: 0.12128639221191406, global metrics: AUC=[0.4641495], BATCH_AUC=[0.4641495]
    2021-07-24 18:09:08,405 - INFO: 	save epoch_id:0 model into: "increment/0"
    PaddleRec Finish
    
    ====================================================================================================
                    Runtime Envs                      Value                                             
    ----------------------------------------------------------------------------------------------------
    train.trainer.trainer                             GeneralTrainer                                    
    train.trainer.executor_mode                       infer                                             
    train.trainer.threads                             2                                                 
    train.trainer.platform                            LINUX                                             
    train.trainer.engine                              single                                            
    ====================================================================================================
    
    QueueDataset can not support PY3, change to DataLoader
    
    ====================================================================================================
                paddlerec Global Envs                 Value                                             
    ----------------------------------------------------------------------------------------------------
    debug                                             False                                             
    workspace                                         .                                                 
    dataset.train_sample.name                         train_sample                                      
    dataset.train_sample.type                         DataLoader                                        
    dataset.train_sample.batch_size                   5                                                 
    dataset.train_sample.data_path                    ./data/                                           
    dataset.train_sample.sparse_slots                 ... 1 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26
    dataset.train_sample.dense_slots                  dense_feature:13                                  
    dataset.infer_sample.name                         infer_sample                                      
    dataset.infer_sample.type                         DataLoader                                        
    dataset.infer_sample.batch_size                   5                                                 
    dataset.infer_sample.data_path                    ./data/                                           
    dataset.infer_sample.sparse_slots                 ... 1 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26
    dataset.infer_sample.dense_slots                  dense_feature:13                                  
    hyper_parameters.optimizer.class                  Adam                                              
    hyper_parameters.optimizer.learning_rate          0.001                                             
    hyper_parameters.optimizer.strategy               async                                             
    hyper_parameters.sparse_inputs_slots              27                                                
    hyper_parameters.sparse_feature_number            1000001                                           
    hyper_parameters.sparse_feature_dim               9                                                 
    hyper_parameters.dense_input_dim                  13                                                
    hyper_parameters.fc_sizes                         [512, 256, 128, 32]                               
    hyper_parameters.distributed_embedding            0                                                 
    mode                                              ['train_runner', 'infer_runner']                  
    runner.train_runner.name                          train_runner                                      
    runner.train_runner.class                         train                                             
    runner.train_runner.epochs                        1                                                 
    runner.train_runner.device                        cpu                                               
    runner.train_runner.init_model_path                                                                 
    runner.train_runner.save_checkpoint_interval      1                                                 
    runner.train_runner.save_inference_interval       1                                                 
    runner.train_runner.save_checkpoint_path          increment                                         
    runner.train_runner.save_inference_path           inference                                         
    runner.train_runner.print_interval                1                                                 
    runner.train_runner.phases                        phase1                                            
    runner.infer_runner.name                          infer_runner                                      
    runner.infer_runner.class                         infer                                             
    runner.infer_runner.device                        cpu                                               
    runner.infer_runner.init_model_path               increment/0                                       
    runner.infer_runner.print_interval                1                                                 
    runner.infer_runner.phases                        infer_phase                                       
    phase.phase1.name                                 phase1                                            
    phase.phase1.model                                ./model.py                                        
    phase.phase1.dataset_name                         train_sample                                      
    phase.phase1.thread_num                           1                                                 
    phase.infer_phase.name                            infer_phase                                       
    phase.infer_phase.model                           ./model.py                                        
    phase.infer_phase.dataset_name                    infer_sample                                      
    phase.infer_phase.thread_num                      1                                                 
    ====================================================================================================
    
    PaddleRec: Runner infer_runner Begin
    Executor Mode: infer
    processor_register begin
    Running SingleInstance.
    Running SingleNetwork.
    Warning:please make sure there are no hidden files in the dataset folder and check these hidden files:[]
    QueueDataset can not support PY3, change to DataLoader
    QueueDataset can not support PY3, change to DataLoader
    Running SingleInferStartup.
    Running SingleInferRunner.
    load persistables from increment/0
    2021-07-24 18:09:10,445 - INFO: 	[Infer] batch: 1, time_each_interval: 0.03s, AUC: [0.468], BATCH_AUC: [0.468]
    2021-07-24 18:09:10,452 - INFO: 	[Infer] batch: 2, time_each_interval: 0.01s, AUC: [0.47630992], BATCH_AUC: [0.47630992]
    2021-07-24 18:09:10,459 - INFO: 	[Infer] batch: 3, time_each_interval: 0.01s, AUC: [0.48376459], BATCH_AUC: [0.48376459]
    2021-07-24 18:09:10,465 - INFO: 	[Infer] batch: 4, time_each_interval: 0.01s, AUC: [0.49327458], BATCH_AUC: [0.50101471]
    2021-07-24 18:09:10,472 - INFO: 	[Infer] batch: 5, time_each_interval: 0.01s, AUC: [0.48323171], BATCH_AUC: [0.48882536]
    2021-07-24 18:09:10,479 - INFO: 	[Infer] batch: 6, time_each_interval: 0.01s, AUC: [0.4925822], BATCH_AUC: [0.49350312]
    2021-07-24 18:09:10,486 - INFO: 	[Infer] batch: 7, time_each_interval: 0.01s, AUC: [0.49944444], BATCH_AUC: [0.495842]
    2021-07-24 18:09:10,492 - INFO: 	[Infer] batch: 8, time_each_interval: 0.01s, AUC: [0.50531915], BATCH_AUC: [0.50623701]
    2021-07-24 18:09:10,499 - INFO: 	[Infer] batch: 9, time_each_interval: 0.01s, AUC: [0.5265542], BATCH_AUC: [0.52281746]
    2021-07-24 18:09:10,506 - INFO: 	[Infer] batch: 10, time_each_interval: 0.01s, AUC: [0.545], BATCH_AUC: [0.54541039]
    2021-07-24 18:09:10,513 - INFO: 	[Infer] batch: 11, time_each_interval: 0.01s, AUC: [0.56849845], BATCH_AUC: [0.57456755]
    2021-07-24 18:09:10,519 - INFO: 	[Infer] batch: 12, time_each_interval: 0.01s, AUC: [0.5827381], BATCH_AUC: [0.59007353]
    2021-07-24 18:09:10,526 - INFO: 	[Infer] batch: 13, time_each_interval: 0.01s, AUC: [0.61095626], BATCH_AUC: [0.64750446]
    2021-07-24 18:09:10,533 - INFO: 	[Infer] batch: 14, time_each_interval: 0.01s, AUC: [0.62126047], BATCH_AUC: [0.68293226]
    2021-07-24 18:09:10,542 - INFO: 	[Infer] batch: 15, time_each_interval: 0.01s, AUC: [0.61708619], BATCH_AUC: [0.73468911]
    Infer infer_phase of epoch increment/0 done, use time: 0.13715481758117676, global metrics: AUC=[0.61708619], BATCH_AUC=[0.73468911]
    PaddleRec Finish

