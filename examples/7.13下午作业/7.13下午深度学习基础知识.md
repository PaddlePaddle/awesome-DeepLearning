# Yolo v5 详细介绍

## 背景

YOLO将物体检测作为回归问题求解。基于一个单独的end-to-end网络，完成从原始图像的输入到物体位置和类别的输出。从网络设计上，YOLO与rcnn、fast rcnn及faster rcnn的区别如下：

[1] YOLO训练和检测均是在一个单独网络中进行。YOLO没有显示地求取region proposal的过程。而rcnn/fast rcnn 采用分离的模块，求取候选框，训练过程因此也是分成多个模块进行。Faster rcnn使用RPN，卷积网络替代rcnn/fast rcnn的selective search模块，将RPN集成到fast rcnn检测网络中，得到一个统一的检测网络。尽管RPN与fast rcnn共享卷积层，但是在模型训练过程中，需要反复训练RPN网络和fast rcnn网络。

[2] YOLO将物体检测作为一个回归问题进行求解，输入图像经过一次inference，便能得到图像中所有物体的位置和其所属类别及相应的置信概率。而rcnn/fast rcnn/faster rcnn将检测结果分为两部分求解：分类问题，回归问题。

## Yolov5 四种网络模型
Yolov5官方代码中，给出的目标检测网络中一共有4个版本，分别是Yolov5s、Yolov5m、Yolov5l、Yolov5x四个模型。
为了更好的理解算法，最好在脑海中对算法网络的整体架构有一个清晰的理解。然而Yolov5代码中给出的网络文件是yaml格式，所以无法用netron工具直接可视化的查看网络结构，但可以采用pt->onnx->netron的折中方式，先使用Yolov5代码中models/export.py脚本将pt文件转换为onnx格式，再用netron工具打开，这样就可以看全网络的整体架构了。四种网络模型算法性能测试图如图1：

 ![a1](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13下午图片\a1.png)
由图1可以看出，Yolov5s网络最小，速度最少，AP精度也最低。但如果检测的以大目标为主，追求速度，倒也是个不错的选择。
其他的三种网络，在此基础上，不断加深加宽网络，AP精度也不断提升，但速度的消耗也在不断增加。
目前使用下来，Yolov5s的模型十几M大小，速度很快，线上生产效果可观，嵌入式设备可以使用。  
因此可以用Yolov5s的网络模型结构为例来查看，从而对Yolov5有更清晰的理解，如图2:

![a2](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13下午图片\a2.png)

从图2的Yolov5的网络结构图，可以看出，Yolov5分为输入端、Backbone、Neck、Prediction四个部分：  
（1）输入端：Mosaic数据增强、自适应锚框计算  
（2）Backbone：Focus结构，CSP结构  
（3）Neck：FPN+PAN结构  
（4)Prediction：GIOU_Loss

### 1.1、输入端
#### 1.1.1、Mosaic数据增强
Yolov5中使用的Mosaic是参考2019年底提出的CutMix数据增强的方式，但CutMix只使用了两张图片进行拼接，而Mosaic数据增强则采用了4张图片，随机缩放、随机裁剪、随机排布的方式进行拼接。而随机缩放、随机裁剪、随机排布的方式进行拼接，对于小目标的检测效果还是很不错的。  
Mosaic数据增强的方式主要有以下优点：
a. 丰富数据集：随机使用4张图片，随机缩放，再随机分布进行拼接，大大丰富了检测数据集，特别是随机缩放增加了很多小目标，让网络的鲁棒性更好。
b. 减少GPU：可能会有人说，随机缩放，普通的数据增强也可以做，但考虑到很多人可能只有一个GPU。因此Mosaic增强训练时，可以直接计算4张图片的数据，使得Mini-batch大小并不需要很大，一个GPU就可以达到比较好的效果。
#### 1.1.2、自适应锚框计算
在Yolo算法中，针对不同的数据集，都会有初始设定长宽的锚框。
在网络训练中，网络在初始锚框的基础上输出预测框，进而和真实框groundtruth进行比对，计算两者差距，再反向更新，迭代网络参数。
因此初始锚框也是比较重要的一部分，比如Yolov5在Coco数据集上初始设定的锚框：

![a3](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13下午图片\a3.png)

训练不同的数据集时，Yolov5将计算初始锚框的值得功能嵌入到了代码中，每次训练时，自适应的计算不同训练集中的最佳锚框值。
当然，如果觉得计算的锚框效果不是很好，也可以在代码中将自动计算锚框功能关闭。 
控制的代码即train.py中上面一行代码，设置成False，每次训练时，不会自动计算。

### 1.2、Backbone
#### 1.2.1Focus结构
Focus结构如图4所示，其中比较关键是切片操作。
比如右图的切片示意图，4×4×3的图像切片后变成2×2×12的特征图。
以Yolov5s的结构为例，原始608×608×3的图像输入Focus结构，采用切片操作，先变成304×304×12的特征图，再经过一次32个卷积核的卷积操作，最终变成304×304×32的特征图。

![a4](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13下午图片\a4.png)

#### 1.2.2、CSP结构
Yolov5中设计了两种CSP结构，以Yolov5s网络为例，以CSP1_X结构应用于Backbone主干网络，另一种CSP2_X结构则应用于Neck中。

![a5](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13下午图片\a5.png)

### 1.3、Neck：FPN+PAN结构
Yolov5中Neck这部分除了使用FPN外，还在此基础上使用了PAN结构。Neck结构中，采用借鉴CSPNet设计的CSP2结构，加强网络特征融合的能力。

![a6](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13下午图片\a6.png)

Yolov5在FPN层的后面还添加了一个自底向上的特征金字塔。其中包含两个PAN结构。这样结合操作，FPN层自顶向下传达强语义特征，而特征金字塔则自底向上传达强定位特征，两两联手，从不同的主干层对不同的检测层进行特征聚合。

### 1.4、Prediction：GIOU_Loss
Yolov5中采用其中的GIOU_Loss做Bounding box的损失函数。$$ {GIOU}_{Loss} = 1 - GIOU = 1 - (IOU - \frac{|差集|}{|C|}  )$$
