# 群组归一化（GroupNorm）方法详解

## 1、概念

深度网络中的数据维度一般是[N, C, H, W]或者[N, H, W，C]格式，N是batch size，H/W是feature的高/宽，C是feature的channel，压缩H/W至一个维度，其三维的表示如图1，假设单个方格的长度是1，那么其表示的是[6, 6，*, * ]下图形象的表示了四种norm的工作方式：

BN在batch的维度上norm，归一化维度为[N，H，W]，对batch中对应的channel归一化；

LN避开了batch维度，归一化的维度为[C，H，W]；

IN 归一化的维度为[H，W]；

而GN介于LN和IN之间，其首先将channel分为许多组（group），对每一组做归一化，及先将feature的维度由[N, C, H, W]，reshape为[N, G，C//G , H, W]，归一化的维度为[C//G , H, W]；

GroupNorm：将channel方向分group，然后每个group内做归一化，算(C//G)HW的均值；这样与batchsize无关，不受其约束。其计算公式如下：

![m1](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13上午图片\m1.png)<center>

​                                                                     图1</center>

## 2、算法流程

算法公式推导过程如下：

$$ \widehat{x_i} = \frac1{\sigma}(x_i - \mu_i) \tag   {公式1}$$

$$ y_i = \gamma\widehat{x_i}+\beta \tag   {公式2}$$

公式1中$x_i$中 $i$ 的含义为$ i = (i_N,i_C,i_H,i_W) $表示四个维度的坐标，这样$ x_i$就是feature map中指定位置的一个点。公式1 中的均值和标准差的计算公式如公式 3 和公式 4 所示：

$$ \mu_i = \frac1{m}\sum_{k\in{S_i}}x_k \tag  {公式3} $$

$$ \sigma_i = \sqrt{\frac1{m}\sum_{k\in{S_i}}(x_k - \mu_i)^2 + \epsilon }\tag  {公式4}$$

以上前四个公式都是常规的归一化操作公式，而BN、LN、IN和GN的差别就在于公式 4 中集合$S_i$的范围。GN的$S_i$如公式 5 所示首先$ k_N = i_N$使得计算都是在一张图的feature map上进行，G表示将C分成G个group，因此G是一个超参数，默认值为32.

$$ S_i = \lbrace k\mid k_N = i_N, [\frac{k_C}{C/G}] = [\frac{i_C}{C/G}] \rbrace \tag  {  公式5} $$

公式 5 中的等式$“[\frac{k_C}{C/G}] = [\frac{i_C}{C/G}]”$表示在同一个group中的点。因此 GN 的思想就是在相同feature map的相同group中进行归一化操作，而group只是在channel维度上进行划分，因此归一化操作就和batch size无关

## 3、作用

Group Normalization是一种新的深度学习归一化方式，可以替代BN。 BN，全名是Batch Normalization。 BN是深度学习中常使用的归一化方法，在提升训练以及收敛速度上发挥了重大的作用，是深度学习上里程碑式的工作。BN是一种归一化方式，而且是以batch的维度做归一化，依赖batch，过小的batch size会导致其性能下降，一般来说每GPU上batch设为32最合适。BN的问题主要是在batch这个维度上进行归一化，但这个维度并不是固定不变的。

Group Normalization（GN）是针对Batch Normalization（BN）在batch size较小时错误率较高而提出的改进算法，因为BN层的计算结果依赖当前batch的数据，当batch size较小时（比如2、4这样），该batch数据的均值和方差的代表性较差，因此对最后的结果影响也较大。
如图2所示，随着batch size越来越小，BN层所计算的统计信息的可靠性越来越差，这样就容易导致最后错误率的上升；而在batch size较大时则没有明显的差别。batch size设置较小时，GN的改进效果就会比较明显。

![m2](C:\Users\spade-卿\Documents\Tencent Files\2606984901\FileRecv\images\7.13上午图片\m2.png)

<center>图2</center>

## 4、应用场景
图像分类，视频分类，目标检测、分割以及视频相关的算法中，由于输入图像较大、维度多样以及算法本身原因等，batch size一般都设置比较小，在此类情况下通常使用GN

