### YouTube深度学习视频推荐系统

#### 1.概念

多任务学习（Multi-Task Learning，MTL）是推荐领域研究的热点。以推荐视频为例，我们可能需要提升很多label，例如提升用户的点赞率、分享率等，在单任务学习中，预测用户点赞动作的模型和预测用户点击分享的模型是两个模型；而在多任务学习中，一个模型一次性就输出了这两个label的预测结果。

多任务模型的一个重要的优点就是节省了计算开销，一个模型干了之前多个模型的事情，这在实时任务中是至关重要的，你给用户推荐，用户不可能刷新一下网页，等个10分钟（夸张一下）才看到你推荐的结果；同时，多任务模型由于联合学习了多个label，附带的也学习了label之间的相关性，这其实是提升了模型的鲁棒性和准确性的，因为单任务模型是无法学习label间的相关性的。多任务学习通常通过 Hard 或 Soft 参数共享来完成。

顾名思义，ShareBottom模型指的就是“共享底部结构的模型”。


#### 2.流程

为了对海量的视频进行快速、准确的排序，YouTube 也采用了经典的召回层 + 排序层的推荐系统架构。YouTube深度学习视频推荐系统流程如下：

<img src="img/YouTube-1.png" alt="来自CSDN" style="zoom:80%;" />

如上所示，Youtube采取了两层深度网络完成整个推荐过程：

第一层是Candidate Generation Model完成候选视频的快速筛选，这一步候选视频集合由百万降低到了百的量级。第二层是用Ranking Model完成几百个候选视频的精排。

该系统从用户的 YouTube 活动历史中提取事件作为输入，然后从一个大的视频库中检索出一个小数据集（上百个视频）。这些候选被认为通常与用户有很精准的相关性。这个候选生成网络仅通过协同过滤（collaborative filtering）提供广泛的个性化。用户之间的相似性可以通过粗粒度特征（例如视频观看的 ID、搜索查询单词以及人口特征统计）表达。

一个推荐列表中出现的一些“最好”的推荐需要一种良好的表征，以在具有高召回率（recall）的候选集中区分相对的重要性。排名网络通过使用一个描述视频与用户的特征集合的期望目标函数来给每个视频打分，从而完成排名的任务。根据它们的得分，然后将最高分的视频展现给用户。

两阶段的推荐方法允许我们从一个很大（数百万）的语料库中进行推荐，与此同时还仍有在设备上出现的少量视频是个性化的吸引用户的内容。此外，这个设计能够和其他源生成的候选进行混合。

#### 3.原理

- **candidate generation模型的架构**

  如下图：自底而上看这个网络，将推荐当成是一个多分类问题，预测问题为：视频库V，有上百万的视频，某用户U，在上下文C上，在时间t时的观看行为，刚好是某个视频i。最底层的输入是用户观看过的video的embedding向量，以及搜索词的embedding向量。特征向量里面包括了用户的地理位置的embedding，年龄，性别等。然后把所有这些特征concatenate起来，传入上层的ReLU神经网络。三层神经网络用softmax函数激活，得到一个应该是在所有candidate video上的概率分布。

![来自CSDN](img/YouTube-2.jpg)

- **ranking模型的架构**

  ranking模型与candidate generation模型唯一的区别就是特征工程。这里引入另一套DNN作为ranking模型的目的，就是引入更多描述视频、用户以及二者之间关系的特征，从而达到对候选视频集合准确排序的目的。

  ![来自CSDN](img/YouTube-3.jpg)

  由上图，从左至右的五个特征依次是impression video ID embedding（当前要计算的video的embedding）、watched video IDs average embedding:（用户观看过的最后N个视频embedding的average pooling）、language embedding（用户语言的embedding和当前视频语言的embedding）、time since last watch（自上次观看同channel视频的时间）和#previous impressions（该视频已经被曝光给该用户的次数）。

  其中，第4个特征用了time since last watch这个特征来反应用户看同类视频的间隔时间。第5个特征#previous impressions则一定程度上引入了exploration的思想，避免同一个视频持续对同一用户进行无效曝光。尽量增加用户没看过的新视频的曝光可能性。

- **训练和测试样本的处理**

  1. 采用softmax对候选集生成模型进行训练是很低效的。Youtube采用word2vec中常用的负采样训练方法减少每次预测的分类数量，从而加快整个模型的收敛速度。
  2. 在对训练集的预处理过程中，Youtube没有采用原始的用户日志，而是 对每个用户提取等数量的训练样本。这样做的目的是减少高度活跃用户对模型损失的过度影响，使模型过于偏向活跃用户的行为模式，忽略数量更广大的长尾用户体验。
  3. 为避免引入未来信息(future information)，产生于事实不符的数据穿越问题。在处理测试集时，Youtube没有采用经典的随机留一法，而是一定要以用户最近一次观看的行为作为测试集。

YouTube 推荐系统的架构是一个典型的召回层加排序层的架构，其中候选集生成模型负责从百万候选集中召回几百个候选视频，排序模型负责几百个候选视频的精排，最终选出几十个推荐给用户。

候选集生成模型是一个典型的 Embedding MLP 的架构，要注意的是它的输出层一个多分类的输出层，预测的是用户点击了“哪个”视频。在候选集生成模型的 serving 过程中，需要从输出层提取出视频 Embedding，从最后一层 ReLU 层得到用户 Embedding，然后利用 最近邻搜索快速 得到候选集。

排序模型同样是一个 Embedding MLP 的架构，不同的是，它的输入层包含了更多的用户和视频的特征，输出层采用了 Weighted LR 作为输出层，并且使用观看时长作为正样本权重，让模型能够预测出观看时长，这更接近 YouTube 要达成的商业目标。

#### 4.场景

作为全球最大的视频分享网站，YouTube 平台中几乎所有的视频都来自 UGC（User Generated Content，用户原创内容），这样的内容产生模式有两个特点：

1. 其商业模式不同于 Netflix，以及国内的腾讯视频、爱奇艺这样的流媒体，这些流媒体的大部分内容都是采购或自制的电影、剧集等头部内容，而 YouTube 的内容都是用户上传的自制视频，种类风格繁多，头部效应没那么明显；

2. YouTube 的视频基数巨大，用户难以发现喜欢的内容。

#### 5.优缺点

- **优点：**可以有效处理大规模数据，减少系统引入的“选择偏见”，优化不用的目标，时效性强。

- **缺点：**模型或许对深度和宽度敏感。

#### 6.引用

[重读Youtube深度学习推荐系统论文，字字珠玑，惊为神文]: https://zhuanlan.zhihu.com/p/52169807

[深入理解YouTube推荐系统算法]: https://zhuanlan.zhihu.com/p/114703091

[YouTube深度学习视频推荐系统]: https://blog.csdn.net/weixin_44127327/article/details/112991157

